name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  OPUS_RELEASE_URL: https://github.com/xiph/opus/releases/download/v1.5.2/opus-1.5.2.tar.gz

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all --all-targets --features tools -- -D warnings

  clippy-dnn:
    name: Clippy DNN (${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - features: deep-plc
            cache-key: deep-plc
          - features: dred
            cache-key: dred
          - features: osce
            cache-key: osce
          - features: dnn
            cache-key: dnn
          - features: "dnn,builtin-weights"
            cache-key: dnn-builtin-weights
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-dnn-${{ matrix.cache-key }}
      - run: cargo clippy -p opurs --all-targets --features "${{ matrix.features }}" -- -D warnings

  clippy-tools-dnn:
    name: Clippy tools-dnn
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-tools-dnn
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: dnn-weights-opus-1.5.2-v2
      - name: Download DNN weight data
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        run: |
          curl -sL $OPUS_RELEASE_URL -o /tmp/opus.tar.gz
          tar -xzf /tmp/opus.tar.gz -C /tmp
          for f in fargan_data.c fargan_data.h plc_data.c plc_data.h pitchdnn_data.c pitchdnn_data.h \
                   dred_rdovae_enc_data.c dred_rdovae_enc_data.h dred_rdovae_dec_data.c dred_rdovae_dec_data.h \
                   dred_rdovae_stats_data.c dred_rdovae_stats_data.h lace_data.c lace_data.h \
                   nolace_data.c nolace_data.h lossgen_data.c lossgen_data.h bbwenet_data.c bbwenet_data.h dred_rdovae_constants.h; do
            cp "/tmp/opus-1.5.2/dnn/$f" "libopus-sys/opus/dnn/$f"
          done
          rm -rf /tmp/opus.tar.gz /tmp/opus-1.5.2
      - run: cargo clippy --all --all-targets --features tools-dnn -- -D warnings

  test:
    name: Test (${{ matrix.name }}, ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        profile: [release, dev]
        exclude:
          # Dev builds are slow; only run on linux-x86_64 to catch debug assertions
          - name: linux-i686
            profile: dev
          - name: macos-arm64
            profile: dev
          - name: macos-x86_64
            profile: dev
          - name: windows-x86_64
            profile: dev
          - name: windows-i686
            profile: dev
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-${{ matrix.profile }}
      - uses: taiki-e/install-action@nextest
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Run tests
        run: cargo nextest run -p opurs --cargo-profile=${{ matrix.profile }} --target ${{ matrix.target }}

  test-dnn:
    name: Test DNN (${{ matrix.name }}, ${{ matrix.features }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - macos-arm64
          - windows-x86_64
        features:
          - deep-plc
          - dred
          - osce
          - dnn
        include:
          - name: linux-x86_64
            os: ubuntu-latest
          - name: macos-arm64
            os: macos-15
          - name: windows-x86_64
            os: windows-latest
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-${{ matrix.name }}-${{ matrix.features }}
      - uses: taiki-e/install-action@nextest
      - name: Run tests
        run: cargo nextest run -p opurs --cargo-profile=release --features "${{ matrix.features }}"

  test-dnn-weights:
    name: Test DNN weights
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-weights
      - uses: taiki-e/install-action@nextest
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: dnn-weights-opus-1.5.2-v2
      - name: Download DNN weight data
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        run: |
          curl -sL $OPUS_RELEASE_URL -o /tmp/opus.tar.gz
          tar -xzf /tmp/opus.tar.gz -C /tmp
          for f in fargan_data.c fargan_data.h plc_data.c plc_data.h pitchdnn_data.c pitchdnn_data.h \
                   dred_rdovae_enc_data.c dred_rdovae_enc_data.h dred_rdovae_dec_data.c dred_rdovae_dec_data.h \
                   dred_rdovae_stats_data.c dred_rdovae_stats_data.h lace_data.c lace_data.h \
                   nolace_data.c nolace_data.h lossgen_data.c lossgen_data.h bbwenet_data.c bbwenet_data.h dred_rdovae_constants.h; do
            cp "/tmp/opus-1.5.2/dnn/$f" "libopus-sys/opus/dnn/$f"
          done
          rm -rf /tmp/opus.tar.gz /tmp/opus-1.5.2
      - name: Run weight verification and integration tests
        run: cargo nextest run --features tools-dnn --cargo-profile=release

  test-vectors:
    name: Vectors (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: vectors-${{ matrix.target }}
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Setup clang
        if: runner.os != 'macos'
        uses: aminya/setup-cpp@v1
        with:
          compiler: llvm
      - name: Build (release)
        run: cargo build --release --features tools --target ${{ matrix.target }}
      - name: Download test vectors
        run: |
          curl https://www.ietf.org/proceedings/98/slides/materials-98-codec-opus-newvectors-00.tar.gz -o vectors.tar.gz
          tar -xzf vectors.tar.gz
      - name: Run test vectors
        run: cargo run --release --features tools --target ${{ matrix.target }} --example run_vectors2 -- opus_newvectors

  test-vectors-dnn:
    name: DNN Vectors (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - macos-arm64
          - windows-x86_64
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: vectors-dnn-${{ matrix.target }}
      - name: Setup clang
        if: runner.os != 'macos'
        uses: aminya/setup-cpp@v1
        with:
          compiler: llvm
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: dnn-weights-opus-1.5.2-v2
      - name: Download DNN weight data
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        shell: bash
        run: |
          curl -sL $OPUS_RELEASE_URL -o /tmp/opus.tar.gz
          tar -xzf /tmp/opus.tar.gz -C /tmp
          for f in fargan_data.c fargan_data.h plc_data.c plc_data.h pitchdnn_data.c pitchdnn_data.h \
                   dred_rdovae_enc_data.c dred_rdovae_enc_data.h dred_rdovae_dec_data.c dred_rdovae_dec_data.h \
                   dred_rdovae_stats_data.c dred_rdovae_stats_data.h lace_data.c lace_data.h \
                   nolace_data.c nolace_data.h lossgen_data.c lossgen_data.h bbwenet_data.c bbwenet_data.h dred_rdovae_constants.h; do
            cp "/tmp/opus-1.5.2/dnn/$f" "libopus-sys/opus/dnn/$f"
          done
          rm -rf /tmp/opus.tar.gz /tmp/opus-1.5.2
      - name: Build (release)
        run: cargo build --release --features tools-dnn --target ${{ matrix.target }}
      - name: Download test vectors
        shell: bash
        run: |
          curl https://www.ietf.org/proceedings/98/slides/materials-98-codec-opus-newvectors-00.tar.gz -o vectors.tar.gz
          tar -xzf vectors.tar.gz
      - name: Run DNN vector tests (72 DRED encode + 192 DNN decode)
        run: cargo run --release --features tools-dnn --target ${{ matrix.target }} --example run_vectors2 -- --dnn-only opus_newvectors

  test-no-simd:
    name: Test no-simd (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: no-simd
      - uses: taiki-e/install-action@nextest
      - name: Run tests (no default features)
        run: cargo nextest run -p opurs --no-default-features
      - name: Run DNN tests (scalar-only, no SIMD)
        run: cargo nextest run -p opurs --no-default-features --features deep-plc

  cross-compile:
    name: Cross (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: android-arm64
            os: ubuntu-latest
            target: aarch64-linux-android
          - name: android-x86_64
            os: ubuntu-latest
            target: x86_64-linux-android
          - name: ios-arm64
            os: macos-15
            target: aarch64-apple-ios
          - name: ios-simulator-arm64
            os: macos-15
            target: aarch64-apple-ios-sim
          - name: windows-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: cross-${{ matrix.target }}
      - name: Build (release)
        run: cargo build --release -p opurs --target ${{ matrix.target }}
      - name: Build with DNN (release)
        run: cargo build --release -p opurs --target ${{ matrix.target }} --features dnn

  docs:
    name: Docs
    runs-on: ubuntu-latest
    env:
      RUSTDOCFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps -p opurs --features dnn

  unsafe-audit:
    name: Unsafe audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Count unsafe in src/
        run: |
          echo "## Unsafe audit" >> $GITHUB_STEP_SUMMARY

          echo "### Core codec (non-SIMD):" >> $GITHUB_STEP_SUMMARY
          core_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep -v '/simd/' | wc -l)
          echo "Files with unsafe (excluding simd/): **$core_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep -v '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SIMD modules (unsafe expected for intrinsics):" >> $GITHUB_STEP_SUMMARY
          simd_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep '/simd/' | wc -l)
          echo "SIMD files with unsafe: **$simd_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          total=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | wc -l)
          echo "Total unsafe occurrences: **$total**" >> $GITHUB_STEP_SUMMARY
