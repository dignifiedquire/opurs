name: CI

on:
  push:
    branches: [main]
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all --all-targets --features tools -- -D warnings

  clippy-dnn:
    name: Clippy DNN (${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - deep-plc
          - dred
          - osce
          - dnn
          - "dnn,builtin-weights"
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-dnn-${{ matrix.features }}
      - run: cargo clippy -p opurs --all-targets --features "${{ matrix.features }}" -- -D warnings

  clippy-tools-dnn:
    name: Clippy tools-dnn
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-tools-dnn
      - run: cargo clippy --all --all-targets --features tools-dnn -- -D warnings

  test:
    name: Test (${{ matrix.name }}, ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        profile: [release, dev]
        exclude:
          # 32-bit dev builds are too slow (unoptimized encoder tests)
          - name: linux-i686
            profile: dev
          - name: windows-i686
            profile: dev
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-${{ matrix.profile }}
      - uses: taiki-e/install-action@nextest
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Run tests
        run: cargo nextest run -p opurs --cargo-profile=${{ matrix.profile }} --target ${{ matrix.target }}

  test-dnn:
    name: Test DNN (${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features:
          - deep-plc
          - dred
          - osce
          - dnn
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-${{ matrix.features }}
      - uses: taiki-e/install-action@nextest
      - name: Run tests
        run: cargo nextest run -p opurs --features "${{ matrix.features }}"

  test-dnn-weights:
    name: Test DNN weights
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-weights
      - uses: taiki-e/install-action@nextest
      - name: Run weight verification and integration tests
        run: cargo nextest run --features tools-dnn --cargo-profile=release

  test-vectors:
    name: Vectors (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: vectors-${{ matrix.target }}
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Setup clang
        if: runner.os != 'macos'
        uses: aminya/setup-cpp@v1
        with:
          compiler: llvm
      - name: Build (release)
        run: cargo build --release --no-default-features --features tools --target ${{ matrix.target }}
      - name: Download test vectors
        run: |
          curl https://www.ietf.org/proceedings/98/slides/materials-98-codec-opus-newvectors-00.tar.gz -o vectors.tar.gz
          tar -xzf vectors.tar.gz
      - name: Run test vectors
        run: cargo run --release --no-default-features --features tools --target ${{ matrix.target }} --example run_vectors2 -- opus_newvectors

  test-no-simd:
    name: Test no-simd (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: no-simd
      - uses: taiki-e/install-action@nextest
      - name: Run tests (no default features)
        run: cargo nextest run -p opurs --no-default-features

  docs:
    name: Docs
    runs-on: ubuntu-latest
    env:
      RUSTDOCFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps -p opurs --features dnn

  unsafe-audit:
    name: Unsafe audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Count unsafe in src/
        run: |
          echo "## Unsafe audit" >> $GITHUB_STEP_SUMMARY

          echo "### Core codec (non-SIMD):" >> $GITHUB_STEP_SUMMARY
          core_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep -v '/simd/' | wc -l)
          echo "Files with unsafe (excluding simd/): **$core_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep -v '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SIMD modules (unsafe expected for intrinsics):" >> $GITHUB_STEP_SUMMARY
          simd_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep '/simd/' | wc -l)
          echo "SIMD files with unsafe: **$simd_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          total=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | wc -l)
          echo "Total unsafe occurrences: **$total**" >> $GITHUB_STEP_SUMMARY
