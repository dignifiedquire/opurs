name: CI

on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  OPUS_DNN_DATA_SHA256: a5177ec6fb7d15058e99e57029746100121f68e4890b1467d4094aa336b6013e
  OPUS_DNN_DATA_CACHE_KEY: dnn-weights-opus-upstream-a5177ec6-v2

jobs:
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all --all-targets --features tools -- -D warnings

  clippy-dnn:
    name: Clippy DNN (${{ matrix.features }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - features: deep-plc
            cache-key: deep-plc
          - features: dred
            cache-key: dred
          - features: osce
            cache-key: osce
          - features: dnn
            cache-key: dnn
          - features: "dnn,builtin-weights"
            cache-key: dnn-builtin-weights
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-dnn-${{ matrix.cache-key }}
      - run: cargo clippy -p opurs --all-targets --features "${{ matrix.features }}" -- -D warnings

  clippy-tools-dnn:
    name: Clippy tools-dnn
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          key: clippy-tools-dnn
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: ${{ env.OPUS_DNN_DATA_CACHE_KEY }}
      - name: Download DNN weight data (upstream model bundle)
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pushd libopus-sys/opus >/dev/null
          sh dnn/download_model.sh "$OPUS_DNN_DATA_SHA256"
          rm -f "opus_data-${OPUS_DNN_DATA_SHA256}.tar.gz"
          popd >/dev/null
      - run: cargo clippy --all --all-targets --features tools-dnn -- -D warnings

  bench-smoke:
    name: Bench smoke (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: bench-smoke
      - name: Build multistream bench
        run: cargo bench --features tools --bench multistream --no-run
      - name: Run short multistream encode bench slices
        run: cargo bench --features tools --bench multistream -- multistream_encode_cmp/rust/1ch_10ms_32000
      - name: Run short multistream encode C slice
        run: cargo bench --features tools --bench multistream -- multistream_encode_cmp/c/1ch_10ms_32000
      - name: Run short multistream decode bench slice
        run: cargo bench --features tools --bench multistream -- multistream_decode_cmp/rust/1ch_10ms_32000
      - name: Run short multistream decode C slice
        run: cargo bench --features tools --bench multistream -- multistream_decode_cmp/c/1ch_10ms_32000
      - name: Generate benchmark summary
        run: |
          ./scripts/criterion_multistream_summary.sh target/criterion target/criterion/multistream-smoke-summary.md
          cat target/criterion/multistream-smoke-summary.md >> "$GITHUB_STEP_SUMMARY"
      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bench-smoke-criterion
          path: |
            target/criterion/multistream_*
            target/criterion/multistream-smoke-summary.md
          if-no-files-found: warn

  examples-smoke:
    name: Examples smoke (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: examples-smoke
      - name: Check opus_demo top-level help
        run: cargo run --release --features tools --example opus_demo -- --help
      - name: Check opus_demo multistream help
        run: cargo run --release --features tools --example opus_demo -- ms-enc-dec --help
      - name: Run multistream demo example
        run: cargo run --release --features tools --example multistream_demo

  test-tools-smoke:
    name: Tools tests smoke (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-tools-smoke
      - name: Run multistream tooling tests
        run: cargo test --features tools --test tools_multistream

  test:
    name: Test (${{ matrix.name }}, ${{ matrix.profile }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        profile: [release, dev]
        exclude:
          # Dev builds are slow; only run on linux-x86_64 to catch debug assertions
          - name: linux-i686
            profile: dev
          - name: macos-arm64
            profile: dev
          - name: macos-x86_64
            profile: dev
          - name: windows-x86_64
            profile: dev
          - name: windows-i686
            profile: dev
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}-${{ matrix.profile }}
      - uses: taiki-e/install-action@nextest
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Run tests
        run: cargo nextest run -p opurs --cargo-profile=${{ matrix.profile }} --target ${{ matrix.target }}

  test-dnn:
    name: Test DNN (${{ matrix.name }}, ${{ matrix.features }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - macos-arm64
          - windows-x86_64
        features:
          - deep-plc
          - dred
          - osce
          - dnn
        include:
          - name: linux-x86_64
            os: ubuntu-latest
          - name: macos-arm64
            os: macos-15
          - name: windows-x86_64
            os: windows-latest
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-${{ matrix.name }}-${{ matrix.features }}
      - uses: taiki-e/install-action@nextest
      - name: Run tests
        run: cargo nextest run -p opurs --cargo-profile=release --features "${{ matrix.features }}"

  test-dnn-weights:
    name: Test DNN weights
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: test-dnn-weights
      - uses: taiki-e/install-action@nextest
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: ${{ env.OPUS_DNN_DATA_CACHE_KEY }}
      - name: Download DNN weight data (upstream model bundle)
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pushd libopus-sys/opus >/dev/null
          sh dnn/download_model.sh "$OPUS_DNN_DATA_SHA256"
          rm -f "opus_data-${OPUS_DNN_DATA_SHA256}.tar.gz"
          popd >/dev/null
      - name: Run weight verification and integration tests
        run: cargo nextest run --features tools-dnn --cargo-profile=release

  test-vectors:
    name: Vectors (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - linux-i686
          - macos-arm64
          - macos-x86_64
          - windows-x86_64
          - windows-i686
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: linux-i686
            os: ubuntu-latest
            target: i686-unknown-linux-gnu
            packages: gcc-multilib
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: macos-x86_64
            os: macos-15-intel
            target: x86_64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - name: windows-i686
            os: windows-latest
            target: i686-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: vectors-${{ matrix.target }}
      - name: Install multilib (Linux i686)
        if: matrix.packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}
      - name: Setup clang
        if: runner.os != 'macos'
        uses: aminya/setup-cpp@v1
        with:
          compiler: llvm
      - name: Build (release)
        run: cargo build --release --features tools --target ${{ matrix.target }}
      - name: Download test vectors
        run: |
          curl https://www.ietf.org/proceedings/98/slides/materials-98-codec-opus-newvectors-00.tar.gz -o vectors.tar.gz
          tar -xzf vectors.tar.gz
      - name: Run test vectors
        run: cargo run --release --features tools --target ${{ matrix.target }} --example run_vectors2 -- opus_newvectors

  test-vectors-dnn:
    name: DNN Vectors (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        name:
          - linux-x86_64
          - macos-arm64
          - windows-x86_64
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - name: macos-arm64
            os: macos-15
            target: aarch64-apple-darwin
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: vectors-dnn-${{ matrix.target }}
      - name: Setup clang
        if: runner.os != 'macos'
        uses: aminya/setup-cpp@v1
        with:
          compiler: llvm
      - name: Cache DNN weight data
        id: dnn-weights
        uses: actions/cache@v4
        with:
          path: |
            libopus-sys/opus/dnn/*_data.*
            libopus-sys/opus/dnn/dred_rdovae_constants.h
          key: ${{ env.OPUS_DNN_DATA_CACHE_KEY }}
      - name: Download DNN weight data (upstream model bundle)
        if: steps.dnn-weights.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pushd libopus-sys/opus >/dev/null
          sh dnn/download_model.sh "$OPUS_DNN_DATA_SHA256"
          rm -f "opus_data-${OPUS_DNN_DATA_SHA256}.tar.gz"
          popd >/dev/null
      - name: Build (release)
        run: cargo build --release --features tools-dnn --target ${{ matrix.target }}
      - name: Download test vectors
        shell: bash
        run: |
          curl https://www.ietf.org/proceedings/98/slides/materials-98-codec-opus-newvectors-00.tar.gz -o vectors.tar.gz
          tar -xzf vectors.tar.gz
      - name: Run DNN vector tests (72 DRED encode + 192 DNN decode)
        run: cargo run --release --features tools-dnn --target ${{ matrix.target }} --example run_vectors2 -- --dnn-only opus_newvectors

  test-no-simd:
    name: Test no-simd (linux-x86_64)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: no-simd
      - uses: taiki-e/install-action@nextest
      - name: Run tests (no default features)
        run: cargo nextest run -p opurs --no-default-features
      - name: Run DNN tests (scalar-only, no SIMD)
        run: cargo nextest run -p opurs --no-default-features --features deep-plc

  cross-compile:
    name: Cross (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - name: android-arm64
            os: ubuntu-latest
            target: aarch64-linux-android
          - name: android-x86_64
            os: ubuntu-latest
            target: x86_64-linux-android
          - name: ios-arm64
            os: macos-15
            target: aarch64-apple-ios
          - name: ios-simulator-arm64
            os: macos-15
            target: aarch64-apple-ios-sim
          - name: windows-arm64
            os: windows-latest
            target: aarch64-pc-windows-msvc
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
        with:
          key: cross-${{ matrix.target }}
      - name: Build (release)
        run: cargo build --release -p opurs --target ${{ matrix.target }}
      - name: Build with DNN (release)
        run: cargo build --release -p opurs --target ${{ matrix.target }} --features dnn

  docs:
    name: Docs
    runs-on: ubuntu-latest
    env:
      RUSTDOCFLAGS: -D warnings
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps -p opurs --features dnn

  unsafe-audit:
    name: Unsafe audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Count unsafe in src/
        run: |
          echo "## Unsafe audit" >> $GITHUB_STEP_SUMMARY

          echo "### Core codec (non-SIMD):" >> $GITHUB_STEP_SUMMARY
          core_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep -v '/simd/' | wc -l)
          echo "Files with unsafe (excluding simd/): **$core_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep -v '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SIMD modules (unsafe expected for intrinsics):" >> $GITHUB_STEP_SUMMARY
          simd_count=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' \
            -l | grep '/simd/' | wc -l)
          echo "SIMD files with unsafe: **$simd_count**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -rlE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | grep '/simd/' >> $GITHUB_STEP_SUMMARY || echo "(none)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          total=$(grep -rE 'unsafe\s*\{|unsafe\s+fn|unsafe\s+impl' src/ --include='*.rs' | wc -l)
          echo "Total unsafe occurrences: **$total**" >> $GITHUB_STEP_SUMMARY
